import json

from pycparser import c_parser

from .syntax_tree_node_object import SyntaxTreeNode
from .syntax_tree_transformer import SyntaxTreeTransformer


class SyntaxTreeService:
    @staticmethod
    def get_syntax_tree_by_code_source(code) -> SyntaxTreeNode:
        parser = c_parser.CParser()
        ast_tree = parser.parse(code.text_view, filename=code.file_name)
        return SyntaxTreeTransformer.transform(ast_tree)

    @staticmethod
    def serialize_syntax_tree_node(syntax_tree_node: SyntaxTreeNode) -> str:
        syntax_tree_dict = syntax_tree_node.to_dict()
        return json.dumps(syntax_tree_dict)

    @staticmethod
    def deserialize_syntax_tree_node(serialized_text: str) -> SyntaxTreeNode:
        syntax_tree_dict: dict = json.loads(serialized_text)
        syntax_tree_node = SyntaxTreeService._dict_to_syntax_tree_node(syntax_tree_dict)

        return syntax_tree_node

    @staticmethod
    def _dict_to_syntax_tree_node(dict_node: dict) -> SyntaxTreeNode | None:
        if dict_node == {}:
            return None

        # В словаре будет только один элемент, соответствующий одной ноде
        node_name = list(dict_node.keys())[0]
        tree_node = SyntaxTreeNode(node_name)

        for child_dict_node in dict_node.values():
            child_node = SyntaxTreeService._dict_to_syntax_tree_node(child_dict_node)
            if child_node is not None:
                tree_node.add_child(child_node)

        return tree_node
